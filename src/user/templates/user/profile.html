{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy - My Profile</title>
    <link rel="stylesheet" href="{% static 'user/css/style2.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="{% url 'store' %}"><h1>ShopEasy</h1></a>
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'store'%}">Store</a></li>
                    <li><a href="{% url 'profile' %}" class="active">Account</a></li>
                    {% if user.user_role != 'customer' and user.is_authenticated %}
                    <li>
                        {% if user.user_role == 'employee' %}
                        <a href="{% url 'employee_view' %}">
                        {% elif user.user_role == 'manager' %}
                        <a href="{% url 'manager_view' %}">
                        {% elif user.user_role == 'inventory_manager' %}
                        <a href="{% url 'inventory_manager_view' %}">
                        {% endif %}
                        {% if user.user_role == 'driver' %}
                        <a href="{% url 'driver_view' %}">
                        {% endif %}
                        Work</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            <div class="header-icons">
                <a href="{% url 'shopping_cart' %}"><i class="fas fa-shopping-cart"></i></a>
                <a href="{% url 'wishlist_view'%}"><i class="fas fa-heart"></i></a>
                <a href="{% url 'profile' %}" id="login-btn"><img src="{{ user.profile.profile_picture.url }}" alt="Profile Picture" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"></a>
            </div>
        </div>
    </header>

    <main>
        <section class="profile">
            <div class="container">
                
                <div class="profile-container">
                    <div class="profile-sidebar">
                        <div class="profile-card">
                            <div class="profile-picture">
                                <img src="{{ user.profile.profile_picture.url }}" alt="Profile Picture" id="profile-picture-preview">
                                
                                <div class="profile-picture-overlay">
                                    <i class="fas fa-camera"></i>
                                    <span>Change Photo</span>
                                </div>
                                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                            </div>
                            <h3>{{ user.first_name|title }} {{ user.last_name|title }}</h3>
                            <p style="color: #3498db; font-size: 15px">{{user.user_role|title}}</p>
                            <p style="font-size: 15px">Member since {{ user.date_joined|date:"Y" }}</p>
                        </div>
                        
                        <nav class="profile-menu">
                            <ul>
                                <li class="active"><a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                                <li><a href="#orders"><i class="fas fa-shopping-bag"></i> Orders</a></li>
                                <li><a href="#addresses"><i class="fas fa-map-marker-alt"></i> Addresses</a></li>
                                <li><a href="#wishlist"><i class="fas fa-heart"></i> Wishlist</a></li>
                                <li><a href="#settings"><i class="fas fa-cog"></i> Account Settings</a></li>
                                <li><a href="#complaints"><i class="fas fa-comment-alt"></i> Complaints</a></li>         
                                <li><a href="{% url 'logout' %}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </nav>
                    </div>
                    
                    <div class="profile-content">
                        <div class="profile-section active" id="dashboard">
                            <h2>Dashboard</h2>
                            <p>Welcome back, {{user.first_name|title}}! Here's what's happening with your account.</p>
                            
                            <div class="dashboard-stats">
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-shopping-bag"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3>{{orders_count}}</h3>
                                        <p>Total Orders</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3>{{wishlist_count}}</h3>
                                        <p>Wishlist Items</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3>{{addresses_count}}</h3>
                                        <p>Saved Addresses</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="recent-orders">
                                <h3>Recent Orders</h3>
                                {% if orders %}
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Date</th>
                                            <th>Items</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            {% comment %} <th>Action</th> {% endcomment %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for order in orders %}
                                        <tr>
                                            <td>#{{order.id}}</td>
                                            <td>{{order.order_date|date:"M d, Y"}}</td>
                                            <td>{{order.products|length}}</td>
                                            <td>{{order.order_price|floatformat:2}}</td>
                                            <td><span class="status {{order.status}}">{{order.status|title}}</span></td>
                                            {% comment %} <td><a href="#" class="btn-view">View</a></td> {% endcomment %}
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                    <div class="order-header">
                                        <div class="order-id">
                                            <span>No orders yet!</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="profile-section" id="orders">
                            <h2>My Orders</h2>
                            <div class="orders-list">
                                <div class="order-card">
                                {% if orders %}
                                {% for order in orders %}
                                    <div class="order-header">
                                        <div class="order-id">
                                            <span>Order #{{order.id}}</span>
                                            <span>Placed on {{order.order_date|date:"M d, Y"}}</span>
                                        </div>
                                        <div class="order-total">
                                            <span>Total: ${{order.order_price|floatformat:2}}</span>
                                            <span class="status {{order.status}}">{{order.status|title}}</span>
                                        </div>
                                    </div>
                                    {% for item in order.products %}
                                    <div class="order-items">
                                        <div class="order-item">
                                            <img src="{{item.product_image}}" alt="Product">
                                            <div class="item-info">
                                                <h4>{{item.product_name}}</h4>
                                                <p>Qty: {{item.quantity}}</p>
                                            </div>
                                            <div class="item-price">{{item.order_price|floatformat:2}}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endfor %}
                                {% else %}
                                    <div class="order-header">
                                        <div class="order-id">
                                            <span>No orders yet!</span>
                                        </div>
                                    </div>
                                {% endif %}
                                    {% comment %} <div class="order-actions">
                                        <button class="btn-reorder">Reorder</button>
                                        <button class="btn-track">Track Order</button>
                                        <button class="btn-details">View Details</button>
                                    </div> {% endcomment %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-section" id="addresses">
                            <h2>My Addresses</h2>
                            <div class="addresses-list">
                                {% for address in addresses %}
                                <div class="address-card" data-address-id="{{ address.id }}">
                                    <div class="address-header">
                                        <h3>{{ address.address_type }}</h3>
                                        <div class="address-actions">
                                            <button class="edit-address" onclick="editAddress({{ address.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="remove-address" onclick="deleteAddress({{ address.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p>{{ address.address }}</p>
                                    {% if address.apartment %}
                                    <p>Apartment/Suite: {{ address.apartment }}</p>
                                    {% endif %}
                                    <p>{{ address.city }}, {{ address.governorate }}</p>
                                </div>
                                {% endfor %}

                                <!-- Add New Address Form -->
                                <div id="add-address-form" style="display: none;">
                                    <div class="address-card">
                                        <h3>Add New Address</h3>
                                        <form id="address-form" class="address-form">
                                            {% csrf_token %}
                                            
                                            <div class="form-group">
                                                <label for="address_type">Address Type</label>
                                                <select id="address_type" name="address_type" required>
                                                    <option value="">Select Address Type</option>
                                                    <option value="Home">Home</option>
                                                    <option value="Work">Work</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label for="address">Street Address</label>
                                                <input type="text" id="address" name="address" required placeholder="Enter your street address">
                                            </div>

                                            <div class="form-group">
                                                <label for="apartment">Apartment/Suite (Optional)</label>
                                                <input type="text" id="apartment" name="apartment" placeholder="Enter apartment or suite number">
                                            </div>

                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label for="city">City</label>
                                                    <input type="text" id="city" name="city" required placeholder="Enter your city">
                                                </div>
                                                <div class="form-group">
                                                    <label for="governorate">Governorate</label>
                                                    <select id="governorate" name="governorate" required>
                                                        <option value="">Select Governorate</option>
                                                        <option value="cairo">Cairo</option>
                                                        <option value="giza">Giza</option>
                                                        <option value="alexandria">Alexandria</option>
                                                        <option value="sharqia">Sharqia</option>
                                                        <option value="gharbia">Gharbia</option>
                                                        <option value="menoufia">Menoufia</option>
                                                        <option value="qalyubia">Qalyubia</option>
                                                        <option value="port_said">Port Said</option>
                                                        <option value="suez">Suez</option>
                                                        <option value="ismailia">Ismailia</option>
                                                        <option value="dakahlia">Dakahlia</option>
                                                        <option value="kafr_el_sheikh">Kafr El Sheikh</option>
                                                        <option value="beheira">Beheira</option>
                                                        <option value="assiut">Assiut</option>
                                                        <option value="sohag">Sohag</option>
                                                        <option value="qena">Qena</option>
                                                        <option value="luxor">Luxor</option>
                                                        <option value="aswan">Aswan</option>
                                                        <option value="red_sea">Red Sea</option>
                                                        <option value="new_valley">New Valley</option>
                                                        <option value="matrouh">Matrouh</option>
                                                        <option value="north_sinai">North Sinai</option>
                                                        <option value="south_sinai">South Sinai</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="form-actions">
                                                <button type="submit" class="btn-primary">Save Address</button>
                                                <button type="button" class="btn-secondary" onclick="toggleAddressForm()">Cancel</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- Edit Address Form -->
                                <div id="edit-address-form" class="address-form" style="display: none;">
                                    <div class="address-card">
                                        <h3>Edit Address</h3>
                                        <form id="edit-address-form-content">
                                            {% csrf_token %}
                                            <input type="hidden" id="edit-address-id" name="address_id">
                                            <div class="form-group">
                                                <label for="edit-address-type">Address Type</label>
                                                <select id="edit-address-type" name="address_type" required>
                                                    <option value="Home">Home</option>
                                                    <option value="Work">Work</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-address">Street Address</label>
                                                <input type="text" id="edit-address" name="address" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-apartment">Apartment/Suite (Optional)</label>
                                                <input type="text" id="edit-apartment" name="apartment">
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-city">City</label>
                                                <input type="text" id="edit-city" name="city" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-governorate">Governorate</label>
                                                <select id="edit-governorate" name="governorate" required>
                                                    <option value="">Select Governorate</option>
                                                    <option value="cairo">Cairo</option>
                                                    <option value="giza">Giza</option>
                                                    <option value="alexandria">Alexandria</option>
                                                    <option value="sharqia">Sharqia</option>
                                                    <option value="gharbia">Gharbia</option>
                                                    <option value="menoufia">Menoufia</option>
                                                    <option value="qalyubia">Qalyubia</option>
                                                    <option value="port_said">Port Said</option>
                                                    <option value="suez">Suez</option>
                                                    <option value="ismailia">Ismailia</option>
                                                    <option value="dakahlia">Dakahlia</option>
                                                    <option value="kafr_el_sheikh">Kafr El Sheikh</option>
                                                    <option value="beheira">Beheira</option>
                                                    <option value="assiut">Assiut</option>
                                                    <option value="sohag">Sohag</option>
                                                    <option value="qena">Qena</option>
                                                    <option value="luxor">Luxor</option>
                                                    <option value="aswan">Aswan</option>
                                                    <option value="red_sea">Red Sea</option>
                                                    <option value="new_valley">New Valley</option>
                                                    <option value="matrouh">Matrouh</option>
                                                    <option value="north_sinai">North Sinai</option>
                                                    <option value="south_sinai">South Sinai</option>
                                                </select>
                                            </div>
                                            <div class="form-actions">
                                                <button type="submit" class="btn-primary">Save Changes</button>
                                                <button type="button" class="btn-secondary" onclick="cancelEdit()">Cancel</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <button type="button" class="btn-add-address" onclick="toggleAddressForm()">+ Add New Address</button>
                            </div>
                        </div>
                        
                        <div class="profile-section" id="wishlist">
                            <h2>My Wishlist</h2>
                            <div class="wishlist-items">
                                {% if wishlist %}
                                {% for product in wishlist %}
                                <div class="product-card" data-product-id="{{product.id}}">
                                    <a href="{% url 'product_view' product.id %}">
                                    <div class="product-image">
                                        <img src="{{product.image.url}}" alt="Product">
                                        <button class="wishlist-heart" onclick="toggleWishlist({{product.id}}, this)" style="display: block; position: absolute; top: 10px; right: 10px; background: transparent; border: none; cursor: pointer;">
                                            <i class="fas fa-heart" style="color: red; font-size: 20px;"></i>
                                        </button>
                                    </div>
                                    <div class="product-info">
                                        <h3>{{product.name}}</h3>
                                        <div class="price">
                                            <span class="current-price">${{product.price}}</span>
                                        </div>
                                        </a>
                                        <div class="product-actions">
                                            <!-- <button class="btn-add-to-cart" onclick="addToCart({{product.id}}, this)">Add one to Cart</button> -->
                                            <script>
                                            function showNotification(message, type = 'success') {
                                                const notification = document.getElementById('notification');
                                                const messageElement = document.getElementById('notification-message');
                                                
                                                // Set message and style
                                                messageElement.textContent = message;
                                                notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
                                                
                                                // Show notification
                                                notification.style.display = 'block';
                                                
                                                // Hide after 3 seconds
                                                setTimeout(() => {
                                                    notification.style.display = 'none';
                                                }, 3000);
                                            }

                                            function addToCart(productId, button) {
                                                button.disabled = true;
                                                button.textContent = 'Adding...';
                                                
                                                fetch(`{% url 'add_to_cart' product_id=0 %}`.replace('0', productId), {
                                                    method: 'POST',
                                                    headers: {
                                                        'X-CSRFToken': '{{ csrf_token }}',
                                                        'Content-Type': 'application/json'
                                                    },
                                                    body: JSON.stringify({ quantity: 1 })
                                                })
                                                .then(response => {
                                                    if (!response.ok) {
                                                        throw new Error('Network response was not ok');
                                                    }
                                                    return response.json();
                                                })
                                                .then(data => {
                                                    if (data.success) {
                                                        // Update cart count in header
                                                        const cartCountElement = document.querySelector('.cart-count');
                                                        if (cartCountElement) {
                                                            cartCountElement.textContent = data.cart_count;
                                                        }
                                                        
                                                        button.textContent = 'Add one more to Cart';
                                                        button.disabled = false;
                                                        button.classList.add('added');
                                                        
                                                        // Show success notification
                                                        showNotification('Product added to cart successfully!');
                                                    } else {
                                                        throw new Error(data.error || 'Failed to add to cart');
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Error:', error);
                                                    showNotification('Failed to add item to cart', 'error');
                                                    button.textContent = 'Add one to Cart';
                                                    button.disabled = false;
                                                });
                                            }
                                            </script>
                                        </div>
                                    </div>
                                </div>
                                
                                <script>
                                function toggleWishlist(productId, button) {
                                    fetch(`/product/wishlist/${productId}/`, {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': '{{ csrf_token }}',
                                            'Content-Type': 'application/json'
                                        }
                                    })
                                    .then(response => {
                                        if (response.ok) {
                                            // Remove the product card from the wishlist
                                            button.closest('.product-card').remove();
                                            
                                            // Check if there are any products left in the wishlist
                                            const wishlistItems = document.querySelector('.wishlist-items');
                                            if (wishlistItems.children.length === 0) {
                                                // If no products left, show the "No wishlist items" message
                                                wishlistItems.innerHTML = `
                                                    <div class="order-header">
                                                        <div class="order-id">
                                                            <span>No wishlist items yet!</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        alert('Failed to remove item from wishlist');
                                    });
                                }
                                </script>
                                {% endfor %}
                                {% else %}
                                <div class="order-header">
                                    <div class="order-id">
                                        <span>No wishlist items yet!</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="profile-section" id="settings">
                            <h2>Account Settings</h2>
                            <form id="profile-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="first-name">First Name</label>
                                        <input type="text" id="first-name" name="first_name" value="{{ user.first_name }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="last-name">Last Name</label>
                                        <input type="text" id="last-name" name="last_name" value="{{ user.last_name }}" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" value="{{ user.email }}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone_number" value="{{ user.profile.phone_number }}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="birthday">Date of Birth</label>
                                    <input type="date" id="birthday" value="1990-01-01">
                                </div>
                                
                                <div class="form-group">
                                    <label>Gender</label>
                                    <div class="radio-group">
                                        <input type="radio" id="male" name="gender" value="male" {% if user.profile.gender == 'male' %}checked{% endif %}>
                                        <label for="male">Male</label>
                                        
                                        <input type="radio" id="female" name="gender" value="female" {% if user.profile.gender == 'female' %}checked{% endif %}>
                                        <label for="female">Female</label>
                                        
                                        <input type="radio" id="other" name="gender" value="other" {% if user.profile.gender == 'other' %}checked{% endif %}>
                                        <label for="other">Other</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-picture">Profile Picture</label>
                                    <input type="file" id="profile-picture" name="profile_picture" accept="image/*">
                                </div>
                                
                                <button type="submit" class="btn-save">Save Changes</button>
                            </form>
                            
                            <div class="change-password">
                                <h3>Change Password</h3>
                                <form id="password-form">
                                    <div class="form-group">
                                        <label for="current-password">Current Password</label>
                                        <input type="password" id="current-password" name="current_password" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="new-password">New Password</label>
                                        <input type="password" id="new-password" name="new_password" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirm-password">Confirm New Password</label>
                                        <input type="password" id="confirm-password" name="confirm_password" required>
                                    </div>
                                    <button type="submit" class="btn-change-password">Change Password</button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Complaints Section -->
                        <div class="profile-section" id="complaints">
                            <h2>Submit a Complaint</h2>
                            <p>Please select the type of complaint you would like to submit.</p>
                            
                            <div id="complaint-types" class="active-complaint-section">
                                <div class="dashboard-stats">
                                    <div class="stat-card" onclick="showComplaintForm('technical')">
                                        <div class="stat-icon">
                                            <i class="fas fa-laptop-code"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Technical Issue</h3>
                                            <p>Website, app, or payment problems</p>
                                        </div>
                                    </div>
                                    <div class="stat-card" onclick="showComplaintForm('product')">
                                        <div class="stat-icon">
                                            <i class="fas fa-box-open"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>Product Issue</h3>
                                            <p>Damaged, defective, or wrong items</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Technical Complaint Form -->
                            <div id="technical-form" class="complaint-form-section" style="display: none; margin-top: 30px;">
                                <h3><i class="fas fa-laptop-code"></i> Technical Issue Report</h3>
                                <p>Please provide details about the technical issue you're experiencing.</p>
                                
                                <button style="margin-bottom: 20px;" class="btn btn-outline" onclick="hideComplaintForms()">
                                    <i class="fas fa-arrow-left"></i> Back to Complaint Types
                                </button>
                                
                                <form id="techForm" class="address-form">
                                    {% csrf_token %}
                                    
                                    <div class="form-group">
                                        <label for="tech-issue-type" class="required-field">Issue Type</label>
                                        <select id="tech-issue-type" name="issue_type" required>
                                            <option value="">Select issue type</option>
                                            <option value="website">Website Problem</option>
                                            <option value="app">Mobile App Issue</option>
                                            <option value="payment">Payment System Error</option>
                                            <option value="account">Account Access Problem</option>
                                            <option value="checkout">Checkout Process Issue</option>
                                            <option value="other">Other Technical Issue</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="tech-page-url">Page URL (if applicable)</label>
                                        <input type="text" id="tech-page-url" name="page_url" placeholder="https://">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="tech-description" class="required-field">Detailed Description</label>
                                        <textarea id="tech-description" name="complaint_description" required placeholder="Please describe the issue in detail, including any error messages you received and steps to reproduce the problem"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="tech-screenshot">Screenshots (if available)</label>
                                        <input type="file" id="tech-screenshot" name="issue_image" accept="image/*" multiple>
                                    </div>
                                    
                                    <div class="form-group">
                                        <button type="submit" class="btn">
                                            <i class="fas fa-paper-plane"></i> Submit Technical Complaint
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Product Complaint Form -->
                            <div id="product-form" class="complaint-form-section" style="display: none;">
                                <h3><i class="fas fa-box-open"></i> Product Issue Report</h3>
                                <p>Please provide details about the product issue you're experiencing.</p>
                                
                                <button  class="btn btn-outline" onclick="hideComplaintForms()">
                                    <i class="fas fa-arrow-left"></i> Back to Complaint Types
                                </button>
                                
                                <form id="prodForm" class="address-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="complaint_type" value="product">
                                    
                                    <div class="form-group">
                                        <label for="prod-order-number">Order Number</label>
                                        <input type="text" id="prod-order-number" name="order_number">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="prod-item" class="required-field">Product Name</label>
                                        <input type="text" id="prod-item" name="product_name" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="prod-date" class="required-field">Purchase Date</label>
                                        <input type="date" id="prod-date" name="purchase_date" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="prod-issue-type" class="required-field">Issue Type</label>
                                        <select id="prod-issue-type" name="issue_type" required>
                                            <option value="">Select issue type</option>
                                            <option value="damaged">Damaged Product</option>
                                            <option value="defective">Defective/Not Working</option>
                                            <option value="wrong">Wrong Item Received</option>
                                            <option value="missing">Missing Parts/Accessories</option>
                                            <option value="quality">Poor Quality</option>
                                            <option value="description">Doesn't Match Description</option>
                                            <option value="other">Other Issue</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="prod-description" class="required-field">Detailed Description</label>
                                        <textarea id="prod-description" name="complaint_description" required placeholder="Please describe the issue in detail, including how the product differs from what you expected"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="prod-photos">Photos of the Issue</label>
                                        <input type="file" id="prod-photos" name="issue_image" accept="image/*" multiple>
                                        <small>Please upload clear photos showing the problem (max 5 files)</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="prod-resolution">Desired Resolution</label>
                                        <select id="prod-resolution" name="desired_resolution">
                                            <option value="">Select preferred resolution</option>
                                            <option value="refund">Full Refund</option>
                                            <option value="replacement">Replacement Product</option>
                                            <option value="partial">Partial Refund</option>
                                            <option value="repair">Repair</option>
                                            <option value="credit">Store Credit</option>
                                            <option value="other">Other Solution</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <button type="submit" class="btn">
                                            <i class="fas fa-paper-plane"></i> Submit Product Complaint
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="notification" class="notification" style="display: none; position: fixed; top: 20px; right: 20px; padding: 15px 25px; background-color: #4CAF50; color: white; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message"></span>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ShopEasy</h3>
                    <p>Your one-stop shop for all your needs.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="{% url 'store' %}">Home</a></li>
                        <li><a href="{% url 'store' %}">Products</a></li>
                        <li><a href="{% url 'shopping_cart' %}">Cart</a></li>
                        <li><a href="{% url 'profile' %}">Account</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Customer Service</h3>
                    <ul>
                        {% comment %} <li><a href="{% url 'complaint' %}">Contact Us</a></li> {% endcomment %}
                        <li><a href="#">FAQs</a></li>
                        <li><a href="#">Returns Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ShopEasy. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="{% static 'user/js/main.js' %}"></script>
    <script>
    function toggleAddressForm() {
        const addAddressForm = document.getElementById('add-address-form');
        const button = document.querySelector('.btn-add-address');
        
        if (!addAddressForm || !button) {
            console.error('Required elements not found');
            return;
        }

        // Hide edit form if it's visible
        const editForm = document.getElementById('edit-address-form');
        if (editForm) {
            editForm.style.display = 'none';
        }

        if (addAddressForm.style.display === 'none') {
            addAddressForm.style.display = 'block';
            button.style.display = 'none';
        } else {
            addAddressForm.style.display = 'none';
            button.style.display = 'block';
        }
    }

    // Handle address form submission
    document.getElementById('address-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = {
            address_type: document.getElementById('address_type').value,
            address: document.getElementById('address').value,
            apartment: document.getElementById('apartment').value || '',
            city: document.getElementById('city').value,
            governorate: document.getElementById('governorate').value
        };

        // Validate required fields
        if (!formData.address_type || !formData.address || !formData.city || !formData.governorate) {
            alert('Please fill in all required fields');
            return;
        }

        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Saving...';
        submitButton.disabled = true;

        fetch('{% url "add_address" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create new address card
                const addressCard = document.createElement('div');
                addressCard.className = 'address-card';
                addressCard.setAttribute('data-address-id', data.address.id);
                addressCard.innerHTML = `
                    <div class="address-header">
                        <h3>${data.address.address_type}</h3>
                        <div class="address-actions">
                            <button class="edit-address" onclick="editAddress(${data.address.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="remove-address" onclick="deleteAddress(${data.address.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p>${data.address.address}</p>
                    ${data.address.apartment ? `<p>Apartment/Suite: ${data.address.apartment}</p>` : ''}
                    <p>${data.address.city}, ${data.address.governorate}</p>
                `;

                // Insert new address card before the form
                const addressesList = document.querySelector('.addresses-list');
                const addAddressForm = document.getElementById('add-address-form');
                addressesList.insertBefore(addressCard, addAddressForm);

                // Reset and hide the form
                document.getElementById('address-form').reset();
                toggleAddressForm();

                // Update address count in dashboard
                const addressCountElement = document.querySelector('.stat-card:nth-child(3) .stat-info h3');
                if (addressCountElement) {
                    const currentCount = parseInt(addressCountElement.textContent);
                    addressCountElement.textContent = currentCount + 1;
                }

                // Show success message
                alert('Address added successfully!');
            } else {
                alert(data.error || 'Failed to add address');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add address');
        })
        .finally(() => {
            // Reset button state
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        });
    });

    // Handle profile form submission
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('action', 'update_profile');

        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Saving...';
        submitButton.disabled = true;

        fetch('{% url "profile_edit" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert('Profile updated successfully!');
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                alert(data.error || 'Failed to update profile');
                submitButton.textContent = originalButtonText;
                submitButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update profile');
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        });
    });

    // Handle password form submission
    document.getElementById('password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            action: 'change_password',
            current_password: document.getElementById('current-password').value,
            new_password: document.getElementById('new-password').value,
            confirm_password: document.getElementById('confirm-password').value
        };

        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Changing...';
        submitButton.disabled = true;

        fetch('{% url "profile_edit" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password changed successfully!');
                this.reset();
            } else {
                alert(data.error || 'Failed to change password');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to change password');
        })
        .finally(() => {
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const profilePicture = document.querySelector('.profile-picture');
        const profilePictureInput = document.getElementById('profile-picture-input');
        const profilePicturePreview = document.getElementById('profile-picture-preview');
        const headerProfilePicture = document.querySelector('#login-btn img');

        profilePicture.addEventListener('click', function() {
            profilePictureInput.click();
        });

        profilePictureInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Preview the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicturePreview.src = e.target.result;
                    headerProfilePicture.src = e.target.result;
                }
                reader.readAsDataURL(file);

                // Upload the image
                const formData = new FormData();
                formData.append('profile_picture', file);
                formData.append('action', 'update_profile');

                // Show loading state
                profilePicture.classList.add('uploading');
                profilePicture.querySelector('.profile-picture-overlay').innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Uploading...</span>';

                fetch('{% url "profile_edit" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update all profile pictures on the page
                        const allProfilePictures = document.querySelectorAll('img[src*="profile_pictures"]');
                        allProfilePictures.forEach(img => {
                            img.src = data.user.profile.profile_picture;
                        });
                        
                        // Show success message
                        const overlay = profilePicture.querySelector('.profile-picture-overlay');
                        overlay.innerHTML = '<i class="fas fa-check"></i><span>Updated!</span>';
                        setTimeout(() => {
                            overlay.innerHTML = '<i class="fas fa-camera"></i><span>Change Photo</span>';
                        }, 2000);
                    } else {
                        throw new Error(data.error || 'Failed to update profile picture');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'Failed to update profile picture');
                    // Revert to original image
                    profilePicturePreview.src = '{{ user.profile.profile_picture.url }}';
                    headerProfilePicture.src = '{{ user.profile.profile_picture.url }}';
                })
                .finally(() => {
                    profilePicture.classList.remove('uploading');
                });
            }
        });

        // Add event listener for logout link
        const logoutLink = document.querySelector('.logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = this.getAttribute('href');
            });
        }
    });

    function editAddress(addressId) {
        // Hide add address form if visible
        const addAddressForm = document.getElementById('add-address-form');
        if (addAddressForm) {
            addAddressForm.style.display = 'none';
        }
        
        // Show edit form
        const editForm = document.getElementById('edit-address-form');
        if (!editForm) {
            console.error('Edit form not found');
            return;
        }
        editForm.style.display = 'block';
        
        // Get address data
        const addressCard = document.querySelector(`.address-card[data-address-id="${addressId}"]`);
        if (!addressCard) {
            console.error('Address card not found');
            return;
        }

        const addressType = addressCard.querySelector('h3').textContent;
        const addressText = addressCard.querySelector('p').textContent;
        const apartmentElement = addressCard.querySelector('p:nth-child(3)');
        const apartment = apartmentElement ? apartmentElement.textContent.replace('Apartment/Suite: ', '') : '';
        const [city, governorate] = addressCard.querySelector('p:last-child').textContent.split(', ');
        
        // Fill form with address data
        document.getElementById('edit-address-id').value = addressId;
        document.getElementById('edit-address-type').value = addressType;
        document.getElementById('edit-address').value = addressText;
        document.getElementById('edit-apartment').value = apartment;
        document.getElementById('edit-city').value = city;
        document.getElementById('edit-governorate').value = governorate;
        
        // Scroll to form
        editForm.scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        const editForm = document.getElementById('edit-address-form');
        if (editForm) {
            editForm.style.display = 'none';
        }
    }

    function deleteAddress(addressId) {
        if (confirm('Are you sure you want to delete this address?')) {
            fetch(`/user/delete-address/${addressId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove address card from DOM
                    const addressCard = document.querySelector(`.address-card[data-address-id="${addressId}"]`);
                    if (addressCard) {
                        addressCard.remove();
                        
                        // Update address count in the dashboard stats
                        const addressCountElement = document.querySelector('.stat-card:nth-child(3) .stat-info h3');
                        if (addressCountElement) {
                            const currentCount = parseInt(addressCountElement.textContent);
                            addressCountElement.textContent = currentCount - 1;
                        }
                        
                        // If no addresses left, show a message
                        const addressesList = document.querySelector('.addresses-list');
                        const remainingAddresses = addressesList.querySelectorAll('.address-card[data-address-id]');
                        if (remainingAddresses.length === 0) {
                            addressesList.innerHTML = `
                                <div class="no-addresses">
                                    <p>No addresses found. Add your first address!</p>
                                    <button type="button" class="btn-add-address" onclick="toggleAddressForm()">+ Add New Address</button>
                                </div>
                            `;
                        }
                    }
                    alert('Address deleted successfully');
                } else {
                    alert(data.error || 'Failed to delete address');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete address');
            });
        }
    }

    // Handle edit address form submission
    document.getElementById('edit-address-form-content').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const addressId = document.getElementById('edit-address-id').value;
        const formData = {
            address_type: document.getElementById('edit-address-type').value,
            address: document.getElementById('edit-address').value,
            apartment: document.getElementById('edit-apartment').value,
            city: document.getElementById('edit-city').value,
            governorate: document.getElementById('edit-governorate').value
        };

        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton ? submitButton.textContent : 'Save Changes';
        if (submitButton) {
            submitButton.textContent = 'Saving...';
            submitButton.disabled = true;
        }

        fetch(`/user/edit-address/${addressId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update address card in DOM
                const addressCard = document.querySelector(`.address-card[data-address-id="${addressId}"]`);
                if (addressCard) {
                    const h3Element = addressCard.querySelector('h3');
                    if (h3Element) h3Element.textContent = data.address.address_type;
                    
                    const firstP = addressCard.querySelector('p');
                    if (firstP) firstP.textContent = data.address.address;
                    
                    if (data.address.apartment) {
                        const apartmentP = addressCard.querySelector('p:nth-child(3)');
                        if (apartmentP) apartmentP.textContent = `Apartment/Suite: ${data.address.apartment}`;
                    }
                    
                    const lastP = addressCard.querySelector('p:last-child');
                    if (lastP) lastP.textContent = `${data.address.city}, ${data.address.governorate}`;
                }
                
                // Hide edit form
                const editForm = document.getElementById('edit-address-form');
                if (editForm) editForm.style.display = 'none';
                
                alert('Address updated successfully');
                // Reload the page to ensure all elements are updated correctly
                window.location.reload();
            } else {
                alert(data.error || 'Failed to update address');
                if (submitButton) {
                    submitButton.textContent = originalButtonText;
                    submitButton.disabled = false;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update address');
            if (submitButton) {
                submitButton.textContent = originalButtonText;
                submitButton.disabled = false;
            }
        });
    });

    // Complaint form functions
    function showComplaintForm(type) {
        document.getElementById('complaint-types').style.display = 'none';
        document.getElementById(type + '-form').style.display = 'block';
    }
    
    function hideComplaintForms() {
        document.getElementById('technical-form').style.display = 'none';
        document.getElementById('product-form').style.display = 'none';
        document.getElementById('complaint-types').style.display = 'block';
    }
    
    // Handle technical complaint form submission
    document.getElementById('techForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Submitting...';
        submitButton.disabled = true;
        
        const formData = new FormData(this);
        formData.append('complaint_type', 'technical');
        
        fetch('{% url "submit_technical_complaint" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success notification
                showNotification('Technical complaint submitted successfully!', 'success');
                
                // Reset form and go back to complaint types
                this.reset();
                hideComplaintForms();
            } else {
                // Show error notification
                showNotification(data.error || 'Failed to submit complaint', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to submit complaint', 'error');
        })
        .finally(() => {
            // Reset button state
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        });
    });
    
    function showNotification(message, type = 'success') {
                                                const notification = document.getElementById('notification');
                                                const messageElement = document.getElementById('notification-message');
                                                
                                                // Set message and style
                                                messageElement.textContent = message;
                                                notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
                                                
                                                // Show notification
                                                notification.style.display = 'block';
                                                
                                                // Hide after 3 seconds
                                                setTimeout(() => {
                                                    notification.style.display = 'none';
                                                }, 3000);
                                            }

    // Handle product complaint form submission
    document.getElementById('prodForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Submitting...';
        submitButton.disabled = true;
        
        const formData = new FormData(this);
        formData.append('complaint_type', 'product');
        
        fetch('{% url "submit_product_complaint" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success notification
                showNotification('Product complaint submitted successfully!', 'success');
                
                // Reset form and go back to complaint types
                this.reset();
                hideComplaintForms();
            } else {
                // Show error notification
                showNotification(data.error || 'Failed to submit complaint', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to submit complaint', 'error');
        })
        .finally(() => {
            // Reset button state
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        });
    });
    
    // File upload preview for complaint forms
    if (document.getElementById('tech-screenshot')) {
        document.getElementById('tech-screenshot').addEventListener('change', function(e) {
            const fileName = Array.from(e.target.files).map(file => file.name).join(', ');
            if (fileName) {
                const small = document.createElement('small');
                small.textContent = 'Selected files: ' + fileName;
                
                // Remove previous message if exists
                const previousSmall = this.nextElementSibling;
                if (previousSmall && previousSmall.tagName === 'SMALL') {
                    previousSmall.remove();
                }
                
                this.parentNode.appendChild(small);
            }
        });
    }
    
    if (document.getElementById('prod-photos')) {
        document.getElementById('prod-photos').addEventListener('change', function(e) {
            const fileName = Array.from(e.target.files).map(file => file.name).join(', ');
            if (fileName) {
                const small = this.nextElementSibling;
                if (small && small.tagName === 'SMALL') {
                    small.textContent = 'Selected files: ' + fileName;
                }
            }
        });
    }
    </script>
</body>
</html>